## Отчёт по решению

### Введение
Чтобы оптимизировать производственные расходы, металлургический комбинат ООО «Так закаляем сталь» решил уменьшить потребление электроэнергии на этапе обработки стали. Нам была поставлена задача построения модели, которая предскажет температуру стали. Модель должна показывать метрику качества MAE < 8.7.

**Описание этапа обработки сплава**

Сталь обрабатывают в металлическом ковше вместимостью около 100 тонн. Чтобы ковш выдерживал высокие температуры, изнутри его облицовывают огнеупорным кирпичом. Расплавленную сталь заливают в ковш и подогревают до нужной температуры графитовыми электродами. Они установлены в крышке ковша. 

Из сплава выводится сера (десульфурация), добавлением примесей корректируется химический состав и отбираются пробы. Сталь легируют — изменяют её состав — подавая куски сплава из бункера для сыпучих материалов или проволоку через специальный трайб-аппарат.

Перед тем как первый раз ввести легирующие добавки, измеряют температуру стали и производят её химический анализ. Потом температуру на несколько минут повышают, добавляют легирующие материалы и продувают сплав инертным газом. Затем его перемешивают и снова проводят измерения. Такой цикл повторяется до достижения целевого химического состава и оптимальной температуры плавки.

Тогда расплавленная сталь отправляется на доводку металла или поступает в машину непрерывной разливки. Оттуда готовый продукт выходит в виде заготовок-слябов.

Температуру перед поступлением партии сплава в машину непрерывной разливки нам и было необходипо спрогнозировать.

Решение поставленной задачи планировалось выполнять в соответствии со следующим планом:

1. **Первичный анализ данных.**
2. **Формирование признаков и выборок для обучения модели.** Данные из семи таблиц объединим в одну, обработаем пропуски и разделим данные на выборки.
3. **Построение модели.** Обучим несколько моделей с подбором гиперпараметров и выберем модель.
4. **Тестирование модели.** Протестируем выбранную модель на тестовой выборке, проверим её на адекватность, оценим важность признаков.
5. **Выводы и отчёт о проделаной работе.**

В целом, все пункты плана были выполнены.

### Данные

Для работы по созданию модели, в наше распоряжение были предоставлены данные состоящие из файлов, полученных из разных источников:
- `data_arc.csv` — данные о нагреве сплава электродами;
- `data_temp.csv` — результаты измерения температуры;
- `data_gas.csv` — данные о продувке сплава газом;
- `data_bulk.csv` — данные о подаче сыпучих материалов (объём);
- `data_bulk_time.csv` *—* данные о подаче сыпучих материалов (время);
- `data_wire.csv` — данные о проволочных материалах (объём);
- `data_wire_time.csv` — данные о проволочных материалах (время).

На этапе первичного анализа, данные из всех таблиц были изучены. 
- **Таблица с данными о нагреве сплава электродами** содержит время начала и окончания нагрева, а также активную и ревктивную мощность, подаваемую на электроды для нагрева. На первый взгляд, корреляции между признаками не наблюдалось, однако было очеведно, что присутствует сильный выброс по реактивной мощности. Также, данные о времени начала и окончания нагрева сами по себе, не дают нам представления о продолжительности нагрева. А мощность подаваемая на электроды не в полной мере отражает энергию нагрева сплава. Поэтому, для более качественного анализа, было решено избавиться от выброса, рассчитать продолжительность нагрева и, на основе продолжительности нагрева и рассчитанной полной мощности, получить энергию нагрева. Проанализировав преобразованную таблицу, стало очевидно, что продолжительность нагрева, мощность и энергия нагрева имеют очень сильную прямую корреляционную зависимость. Таким образом, наиболее целесообразно в построении модели использовать один из этих признаков. Лучше всего на эту роль подходит энергия нагрева, так как в ней содержится и время нагрева и приложенные активная и реактивная мощность.
- **Таблица с данными о результатах измерения температуры** содержит данные о времени замера и результате замера в градусах. Из данной таблицы предполагалось взять последний замер температуры для каждой партии сплава как целевой признак. Остальные замеры температуры можно использовать как признаки для работы модели. Однако, количество замеров температуры, от партии к партии варьируется от 1 до 16. Партии сплава с одним замером мы не сможем использовать в модели так как такие партии будут иметь только целевой признак, а начальной температуры у нас не будет. Следовательно модели не от чего будет отталкиваться в своей работе. Поэтому такие партии следовало удалить. В остальных партиях, проблема заключалась в том, что количество замеров температуры оказывалось разным. А в модель необходимо подавать чётко определённое количество признаков. Поэтому необходимо было либо, до подачи в модель, прогнозировать недостающие замеры для партий сплава у которых количество замеров меньше максимального, либо подавать в модель только один начальный замер температуры, ведь он есть у всех партий. Решено было действовать по второму варианту. Также, было выявлено несколько замеров температуры сплава с температурой меньше температуры плавления стали. Это мог быть либо брак, при котором сплав застыл раньше времени, либо какя либо особенная партия сплава. Решено было избавиться от партий сплава, где есть такие данные.
- **Таблица с данными о продувке сплава газом** содержат объём инертного газа, продуваемого через сплав для каждой партии. Исходя из анализа данной таблицы, продувка каждой партии сплава газом осуществляется один раз. Объём газа для продувания сплава лежит в диапозоне от 0.008 до 78 с медианным значением 11.
- **Таблицы с данными о подаче сыпучих материалов** содержат данные о количестве и времени подачи сыпучих материалов в сплав, для достижения необходимых свойств сплава. В среднем, в каждую партию сплава добавляется 3 - 4 сыпучие добавки. Также можно отметить, что добавка `Bulk 1` всегда добавляется с `Bulk 13` а добавка `Bulk 7` всегда добавляется с `Bulk 14`. (По крайней мере в рамках представленного набора данных)
- **Таблицы с данными о проволочных материалах** содержат данные о количестве и времени подачи проволочных материалах в сплав. В каждую партию сплава добавляется, как правило, 1 - 2 проволочных добавок. Добавка Wire 5 добавлялась только в одну партию, добавки Wire 4, Wire 7 и Wire 8 добавлялись в менее чем 20 партий.

При первичном анализе данных были обнаружены пропуски:
- В таблице с данными о результатах измерения температуры - такие данные мы не можем использовать, поэтому они подлежали удалению;
- В таблицах с данными о подаче сыпучих и проволочных материалов - означают что данная добавка не добавлялась в текущую партию сплава. Такие пропуски необходимо было заменить на нули.

Текже, стоит отметить, что во всех таблицах количество уникальных партий сплава было разным. Эта проблема была решена на этапе подготовки данных.





### Подготовка данных

Подготовка данных к обучению модели была начата с обработки пропусков, выбрасов и устранения проблемм с одиночными замерами температуры.
Затем данные из таблиц были объеденены в следующей последовательности:
1. Сначала были взяты данные из таблицы с замерами температуры. Из неё взяли время первого и последнего замера температуры. Затем, по этому времени присоединили из этой-же таблицы температуру первого и последнего замера. После этого была рассчитана продолжительность приготовления партии сплава, как разность между конечным и начальным временем замеров температуры сплава. После чего, астрономическое время начала и окончания приготовления партии сплава было удалено из таблицы.
2. К таблице, полученной на первом шаге, по идентификатору партии `key`, добавили данные из таблицы с данными о нагреве сплава электродами, предварительно рассчитав суммарную продолжительность и энегрию нагрева партии. Добавляли не всю таблицу, а только данные о времени нагрева и энергии нагрева.
3. Далее, к итоговой таблице, добавили по идентификатору партии сплава, данные о добавлении сыпучих и проволочных материалов, а также об объёме продуваемого через сплав газа.

После получения итоговой таблицы с признаками, было решено добавить некоторые признаки, рассчитанные на основе уже имеемых:
1. Признак, характеризующий, сколько энергии нагрева потратили за секунду общего времени приготовления сплава;
2. Признак характеризующий время охлаждения сплава;
3. Признак характеризующий отношение времени нагрева к общему времени приготовления сплава.

С учётом того, что несколько признаков были сгенерированны на основе первоначально представленных в таблицах с исходными данными, итоговую таблицу с признаками, было решено проанализировать на наличие взаимосвязей. По результатам такого исследования было решено не использовать в работе модели признаки:
- `total_time`- общее время приготовления партии сплава - как имеющую сильную корреляцию с признаком `cool_time` - время охлаждения сплава;
- `heating_time`- общее время нагрева партии сплава - как имеющую сильную корреляцию с признаком `total_energy` - энергия нагрева сплава. Время нагрева входит в формулу расчёта энергии, и использовать его в модели не планировалось изначально;
- `energy_per_second`- энергия нагрева, потраченная за секунду общего времени приготовления сплава - как имеющую сильную корреляцию с признаком `scaller_time` - отношение времени нагрева к общему времени приготовления сплава.

В итоге, после всех преобразований имеем таблицу в которой 28 признаков + 1 целевой признак и 2324 строки. С учётом того, что строк в итоговой таблице с признаками осталось давольно не большое количество, делить полученный набор данных было решено на две выборки: тренировачную и тестовую. Проверку работы модели на этапе тренировки моделей и подбора гиперпараметров, осуществляли способом перекрёстной валидации.



### Построение, выбор и тестирование модели машинного обучения

На полученных данных, было решено обучить несколько моделей машинного обучения и выбрать из них лучшую. В таблице приведены результаты моделей на тренировочной выборке, полученные с помощью перекрёстной проверки и с подобранными оптимальными гиперпараметрами..

|№п\п|Модель| MAE | Примечание |
|:----|:----|:----|:------|
|1.| **Линейная регрессия**|**6.57**| Перед обучением линейной модели, данные были предварительно нормализованы.|
|2.| **Решающее дерево**| **6.99**| Гиперпараметр `max_depth`=6|
|3.| **Случайный лес**| **5.97**| Гиперпараметры `max_depth`=14, `n_estimators`=200|
|4.| **CatBoostRegressor**| **5.75**|Гиперпараметры `l2_leaf_reg`=1, `learning_rate`=0.02, `depth`=5|

Модель **CatBoostRegressor** показывает лучшую метрику качества. На тестировании, данная модель показала **MAE=5.59**, что несколько лучше чем на кроссвалидации. Видимо причина улучшения метрики в том, что обучение модели перед тестированием производилось на полной тренировочной выборки, а не на частичной как при кроссвалидации. Константная модель и модель дающая прогноз равный начальной температуры показывают результат хуже созданной модели.

**Вывод**

Таким образом созданная модель **CatBoostRegressor** решает поставленную задачу с заданным качеством, и именно её я бы рекомендовал принимать в производство.
